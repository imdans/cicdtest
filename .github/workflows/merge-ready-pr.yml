name: Merge Ready PRs

on:
  pull_request_target:
    types: [labeled, reopened, synchronize]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: >
      ${{ github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'pull_request_target' &&
           github.event.pull_request.base.ref == 'main' &&
           github.event.pull_request.head.ref == 'dev' &&
           contains(github.event.pull_request.labels.*.name, 'ready-to-merge')) }}
    runs-on: ubuntu-latest
    steps:
      - name: Check PR token
        id: check_token
        run: |
          if [ -n "${{ secrets.PR_TOKEN }}" ]; then
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_token=false" >> "$GITHUB_OUTPUT"
            echo "PR_TOKEN not set. Skipping merge."
          fi

      - name: Authenticate gh
        if: steps.check_token.outputs.has_token == 'true'
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
        run: gh auth status

      - name: Resolve PR number
        if: steps.check_token.outputs.has_token == 'true'
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          num="${{ github.event.pull_request.number }}"
          if [ -z "$num" ]; then
            num=$(gh pr list --base main --head dev --label ready-to-merge --state open --json number --jq '.[0].number')
          fi
          if [ -n "$num" ]; then
            echo "number=$num" >> "$GITHUB_OUTPUT"
          else
            echo "No ready PR found. Exiting."
            exit 0
          fi

      - name: Merge PR (squash and delete branch)
        if: steps.check_token.outputs.has_token == 'true' && steps.resolve.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          gh pr merge "${{ steps.resolve.outputs.number }}" --squash --delete-branch